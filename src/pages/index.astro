---
import MainLayout from "../layouts/MainLayout.astro";
import { site } from "../lib/site";
import { drivers, races, getDriverById } from "../lib/data";

// Ordenar carreras por fecha (m√°s reciente primero)
const sortedRaces = [...races].sort((a, b) => {
  const da = new Date(a.date).getTime();
  const db = new Date(b.date).getTime();
  if (db !== da) return db - da;
  return (b.round ?? 0) - (a.round ?? 0);
});

const latestRace = sortedRaces[0];

// Mini podio por categor√≠a para la √öLTIMA fecha
type MiniEntry = {
  position: number;
  driverId: string;
  driverName: string;
  driverNumber?: number;
  team?: string;
};

type MiniPodiumCategory = {
  category: string;
  entries: MiniEntry[];
};

let miniPodiumByCategory: MiniPodiumCategory[] = [];

if (latestRace) {
  const map = new Map<string, MiniEntry[]>();

  for (const entry of latestRace.podium) {
    const driver = getDriverById(entry.driverId);
    if (!driver) continue;

    const cat = driver.category ?? "Sin categor√≠a";

    if (!map.has(cat)) map.set(cat, []);
    map.get(cat)!.push({
      position: entry.position,
      driverId: driver.id,
      driverName: driver.name,
      driverNumber: driver.number,
      team: driver.team,
    });
  }

  miniPodiumByCategory = Array.from(map.entries())
    .map(([category, entries]) => ({
      category,
      entries: entries.sort((a, b) => a.position - b.position),
    }))
    .sort((a, b) => a.category.localeCompare(b.category));
}

// Info r√°pida
const totalDrivers = drivers.length;
const totalRaces = races.length;
const totalFastestLaps = races.filter((r) => r.fastestLap?.driverId).length;

// Fastest lap overall (mejor tiempo absoluto)
let absoluteFastest:
  | {
      raceId: string;
      round: number;
      track: string;
      driverId: string;
      driverName: string;
      time: string;
      date: string;
    }
  | undefined = undefined;

for (const race of races) {
  if (!race.fastestLap?.time) continue;
  const driver = getDriverById(race.fastestLap.driverId);
  if (!driver) continue;

  const time = race.fastestLap.time;
  const currentMs = Number(time.replace(":", "").replace(".", ""));
  if (!absoluteFastest) {
    absoluteFastest = {
      raceId: race.id,
      round: race.round,
      track: race.track,
      driverId: driver.id,
      driverName: driver.name,
      time,
      date: race.date,
    };
  } else {
    const bestMs = Number(
      absoluteFastest.time.replace(":", "").replace(".", "")
    );
    if (currentMs < bestMs) {
      absoluteFastest = {
        raceId: race.id,
        round: race.round,
        track: race.track,
        driverId: driver.id,
        driverName: driver.name,
        time,
        date: race.date,
      };
    }
  }
}
---

<MainLayout
  title={site.name}
  description="Liga de karting amateur entre amigos. Resultados, pilotos, fotos y fastest laps."
  image="/og-home.jpg"
  path="/"
>
  <!-- HERO -->
  <section class="mb-10 grid gap-6 md:grid-cols-[1.6fr,1fr] items-start">
    <div>
      <p class="text-[11px] font-semibold uppercase tracking-[0.26em] text-slate-400">
        Liga amateur ¬∑ Karting
      </p>
      <h1 class="mt-3 text-3xl font-semibold tracking-tight sm:text-4xl md:text-5xl">
        La pole es buena‚Ä¶<br class="hidden sm:block" />
        <span class="bg-gradient-to-r from-fuchsia-400 via-purple-400 to-sky-400 bg-clip-text text-transparent">
          pero la amistad es mejor.
        </span>{' '}
        üèÅüíúüèéÔ∏è
      </h1>
      <p class="mt-4 max-w-xl text-sm text-slate-300">
        Somos un grupo de pilotos amateur de diferentes equipos y categor√≠as,
        unidos por lo mismo: girar m√°s r√°pido, pelear rueda a rueda y terminar
        ri√©ndonos en el box.
      </p>

      <div class="mt-5 flex flex-wrap gap-3 text-xs">
        <a
          href="/pilotos"
          class="inline-flex items-center rounded-full bg-fuchsia-600 px-4 py-2 font-medium text-white shadow-[0_0_24px_rgba(244,114,182,0.7)] hover:bg-fuchsia-500 transition-colors"
        >
          Ver pilotos
        </a>
        <a
          href="/galeria"
          class="inline-flex items-center rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 font-medium text-slate-100 hover:border-fuchsia-500/70 hover:text-fuchsia-300 transition-colors"
        >
          Galer√≠a de fotos
        </a>
        <a
          href="/resultados"
          class="inline-flex items-center rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 font-medium text-slate-100 hover:border-fuchsia-500/70 hover:text-fuchsia-300 transition-colors"
        >
          Tabla de resultados
        </a>
      </div>
    </div>

    <!-- Fastest Lap absoluta -->
    <div class="rounded-2xl border border-slate-800 bg-[#050515] p-4 text-xs shadow-[0_0_40px_rgba(15,23,42,0.9)]">
      <p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
        Fastest lap absoluta
      </p>
      {absoluteFastest ? (
        <>
          <div class="mt-3 flex items-baseline justify-between gap-2">
            <div>
              <p class="text-[11px] text-slate-400">Piloto</p>
              <a
                href={`/pilotos/${absoluteFastest.driverId}`}
                class="text-sm font-semibold text-fuchsia-300 hover:text-fuchsia-200 transition-colors"
              >
                {absoluteFastest.driverName}
              </a>
            </div>
            <div class="text-right">
              <p class="text-[11px] text-slate-400">Tiempo</p>
              <p class="text-lg font-semibold text-fuchsia-300">
                {absoluteFastest.time}
              </p>
            </div>
          </div>
          <div class="mt-3 border-t border-slate-800 pt-3 text-[11px] text-slate-400">
            <p>
              Ronda {absoluteFastest.round} ¬∑ {absoluteFastest.track}
            </p>
            <p class="mt-1">
              {new Date(absoluteFastest.date).toLocaleDateString('es-PY', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
              })}
            </p>
          </div>
        </>
      ) : (
        <p class="mt-3 text-sm text-slate-400">
          Todav√≠a no hay vueltas r√°pidas registradas.
        </p>
      )}
    </div>
  </section>

  <!-- √öLTIMA FECHA -->
  {latestRace && (
    <section class="mb-8 rounded-2xl border border-slate-800 bg-[#050515] p-4 text-xs">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
            √öltima fecha
          </p>
          <p class="mt-1 text-sm font-semibold text-slate-100">
            Ronda {latestRace.round} ¬∑ {latestRace.track}
          </p>
          {latestRace.layout && (
            <p class="text-[11px] text-slate-400">
              Layout: {latestRace.layout}
            </p>
          )}
        </div>
        <div class="text-right text-xs text-slate-400">
          <p>
            {new Date(latestRace.date).toLocaleDateString('es-PY', {
              day: '2-digit',
              month: 'short',
              year: 'numeric',
            })}
          </p>
        </div>
      </div>

      <div class="mt-3 grid gap-4 md:grid-cols-[1.2fr,1.1fr]">
        <!-- Podio general -->
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
            Podio general
          </p>
          <ol class="mt-2 space-y-1 text-xs">
            {latestRace.podium.map((entry) => {
              const d = getDriverById(entry.driverId);
              if (!d) return null;
              return (
                <li class="flex items-center justify-between rounded-lg bg-slate-900/70 px-3 py-1.5">
                  <div class="flex items-center gap-2">
                    <span
                      class={[
                        'flex h-5 w-5 items-center justify-center rounded-full text-[11px] font-semibold',
                        entry.position === 1 && 'bg-amber-400 text-slate-900',
                        entry.position === 2 && 'bg-slate-300 text-slate-900',
                        entry.position === 3 && 'bg-amber-700 text-slate-50',
                        entry.position > 3 && 'bg-slate-700 text-slate-100',
                      ]
                        .filter(Boolean)
                        .join(' ')}
                    >
                      {entry.position}
                    </span>
                    <a
                      href={`/pilotos/${d.id}`}
                      class="font-medium text-slate-100 hover:text-fuchsia-300 transition-colors"
                    >
                      {d.name}
                    </a>
                  </div>
                  <div class="flex items-center gap-2 text-[11px] text-slate-400">
                    {d.number && <span>#{d.number}</span>}
                    {d.team && (
                      <span class="hidden sm:inline text-slate-500">
                        {d.team}
                      </span>
                    )}
                  </div>
                </li>
              );
            })}
          </ol>
        </div>

        <!-- Fastest lap de la fecha -->
        <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-3">
          <p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
            Fastest lap de la fecha
          </p>
          {latestRace.fastestLap?.driverId ? (
            (() => {
              const d = getDriverById(latestRace.fastestLap.driverId);
              if (!d) {
                return (
                  <p class="mt-2 text-xs text-slate-400">
                    Vuelta r√°pida registrada sin piloto v√°lido.
                  </p>
                );
              }
              return (
                <div class="mt-2 flex items-baseline justify-between gap-2">
                  <div>
                    <p class="text-[11px] text-slate-400">Piloto</p>
                    <a
                      href={`/pilotos/${d.id}`}
                      class="text-sm font-semibold text-fuchsia-300 hover:text-fuchsia-200 transition-colors"
                    >
                      {d.name}
                    </a>
                  </div>
                  <div class="text-right">
                    <p class="text-[11px] text-slate-400">Tiempo</p>
                    <p class="text-lg font-semibold text-fuchsia-300">
                      {latestRace.fastestLap.time}
                    </p>
                  </div>
                </div>
              );
            })()
          ) : (
            <p class="mt-2 text-xs text-slate-400">
              Todav√≠a no se carg√≥ la vuelta r√°pida de esta fecha.
            </p>
          )}
        </div>
      </div>
    </section>
  )}

  <!-- MINI PODIO POR CATEGOR√çA (√öLTIMA FECHA) -->
  {latestRace && miniPodiumByCategory.length > 0 && (
    <section class="mb-8">
      <h2 class="mb-2 text-sm font-semibold uppercase tracking-[0.22em] text-slate-400">
        Mini podio por categor√≠a ¬∑ √∫ltima fecha
      </h2>
      <p class="mb-3 text-[11px] text-slate-400">
        Basado en la ronda {latestRace.round} ¬∑ {latestRace.track}
      </p>

      <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
        {miniPodiumByCategory.map((cat) => (
          <article class="rounded-xl border border-slate-800 bg-[#050515] p-3 text-xs">
            <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-fuchsia-300">
              {cat.category}
            </p>
            <ol class="mt-2 space-y-1">
              {cat.entries.map((e) => (
                <li class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span
                      class={[
                        'flex h-5 w-5 items-center justify-center rounded-full text-[11px] font-semibold',
                        e.position === 1 && 'bg-amber-400 text-slate-900',
                        e.position === 2 && 'bg-slate-300 text-slate-900',
                        e.position === 3 && 'bg-amber-700 text-slate-50',
                        e.position > 3 && 'bg-slate-700 text-slate-100',
                      ]
                        .filter(Boolean)
                        .join(' ')}
                    >
                      {e.position}
                    </span>
                    <a
                      href={`/pilotos/${e.driverId}`}
                      class="font-medium text-slate-100 hover:text-fuchsia-300 transition-colors"
                    >
                      {e.driverName}
                    </a>
                  </div>
                  <div class="flex items-center gap-2 text-[11px] text-slate-400">
                    {e.driverNumber && <span>#{e.driverNumber}</span>}
                  </div>
                </li>
              ))}
            </ol>
          </article>
        ))}
      </div>
    </section>
  )}

  <!-- INFO R√ÅPIDA -->
  <section class="mb-10">
    <h2 class="mb-3 text-sm font-semibold uppercase tracking-[0.22em] text-slate-400">
      Info r√°pida de la liga
    </h2>

    <div class="grid gap-3 sm:grid-cols-3">
      <div class="rounded-xl border border-slate-800 bg-[#050515] px-4 py-3 text-xs">
        <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
          Pilotos registrados
        </p>
        <p class="mt-2 text-2xl font-semibold text-slate-50">
          {totalDrivers}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Diferentes equipos y categor√≠as.
        </p>
      </div>

      <div class="rounded-xl border border-slate-800 bg-[#050515] px-4 py-3 text-xs">
        <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
          Fechas disputadas
        </p>
        <p class="mt-2 text-2xl font-semibold text-slate-50">
          {totalRaces}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Entre Super Kart, KCP y Brasil.
        </p>
      </div>

      <div class="rounded-xl border border-slate-800 bg-[#050515] px-4 py-3 text-xs">
        <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
          Vueltas r√°pidas registradas
        </p>
        <p class="mt-2 text-2xl font-semibold text-fuchsia-300">
          {totalFastestLaps}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Una por fecha
        </p>
      </div>
    </div>
  </section>
</MainLayout>
