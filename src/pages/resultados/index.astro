---
// src/pages/resultados/index.astro

import MainLayout from '../../layouts/MainLayout.astro';
import {
	drivers,
	races,
	getBestLapForDriver,
	getDriverById,
} from '../../lib/data';

// Construir stats por piloto
type Standing = {
	driverId: string;
	name: string;
	number?: number;
	team?: string;
	category?: string;
	totalRaces: number;
	podiums: number;
	wins: number;
	fastestLaps: number;
	bestPosition: number | null;
	bestLapTime: string | null;
};

const standingsMap = new Map<string, Standing>();

for (const d of drivers) {
	standingsMap.set(d.id, {
		driverId: d.id,
		name: d.name,
		number: d.number,
		team: d.team,
		category: d.category,
		totalRaces: 0,
		podiums: 0,
		wins: 0,
		fastestLaps: 0,
		bestPosition: null,
		bestLapTime: null,
	});
}

// Recorrer carreras y llenar stats
for (const race of races) {
	// posiciones finales
	for (const pos of race.podium) {
		const s = standingsMap.get(pos.driverId);
		if (!s) continue;

		s.totalRaces += 1;
		if (pos.position <= 3) s.podiums += 1;
		if (pos.position === 1) s.wins += 1;

		if (s.bestPosition === null || pos.position < s.bestPosition) {
			s.bestPosition = pos.position;
		}
	}

	// fastest laps
	if (race.fastestLap?.driverId) {
		const s = standingsMap.get(race.fastestLap.driverId);
		if (s) {
			s.fastestLaps += 1;
		}
	}
}

// Mejor tiempo absoluto por piloto
for (const [id, s] of standingsMap) {
	const bestLap = getBestLapForDriver(id);
	s.bestLapTime = bestLap ? bestLap.time : null;
}

// Array overall
const overallStandings: Standing[] = Array.from(standingsMap.values()).sort(
	(a, b) => {
		// ordenar por mejor posición, luego por mejor tiempo, luego por nombre
		const aPos = a.bestPosition ?? 999;
		const bPos = b.bestPosition ?? 999;
		if (aPos !== bPos) return aPos - bPos;

		if (a.bestLapTime && b.bestLapTime) {
			const aT = parseFloat(a.bestLapTime);
			const bT = parseFloat(b.bestLapTime);
			if (Number.isFinite(aT) && Number.isFinite(bT) && aT !== bT) {
				return aT - bT;
			}
		}

		return a.name.localeCompare(b.name);
	}
);

// Agrupar por categoría
const categoriesMap = new Map<string, Standing[]>();

for (const s of overallStandings) {
	const cat = s.category || 'Sin categoría';
	if (!categoriesMap.has(cat)) categoriesMap.set(cat, []);
	categoriesMap.get(cat)!.push(s);
}

const categories = Array.from(categoriesMap.entries()).sort(([a], [b]) =>
	a.localeCompare(b)
);
---

<MainLayout
	title="Resultados · Pericos"
	description="Resumen de resultados de la liga: carreras disputadas, podios, victorias, vueltas rápidas y mejores tiempos por piloto."
	image="/og-resultados.jpg"
	path="/resultados">
	<section class="mb-6">
		<h1 class="text-2xl font-semibold tracking-tight sm:text-3xl">
			Resultados generales
		</h1>
		<p class="mt-2 text-sm text-slate-300">
			Estadísticas por piloto: carreras, podios, victorias, vueltas rápidas,
			mejor posición y mejor tiempo registrado. Sin puntos, solo data real de
			pista.
		</p>
	</section>

	<!-- OVERALL -->
	<section class="mb-10">
		<h2
			class="mb-3 text-sm font-semibold uppercase tracking-[0.22em] text-slate-400">
			Overall (todas las categorías)
		</h2>

		<div
			class="overflow-x-auto rounded-xl border border-slate-800 bg-[#050515]">
			<table class="min-w-full text-left text-xs">
				<thead
					class="border-b border-slate-800 bg-slate-900/60 text-[11px] uppercase tracking-[0.18em] text-slate-400">
					<tr>
						<th class="px-3 py-2">Pos</th>
						<th class="px-3 py-2">Piloto</th>
						<th class="px-3 py-2">#</th>
						<th class="px-3 py-2">Equipo</th>
						<th class="px-3 py-2">Categoría</th>
						<th class="px-3 py-2 text-right">Carreras</th>
						<th class="px-3 py-2 text-right">Podios</th>
						<th class="px-3 py-2 text-right">Victorias</th>
						<th class="px-3 py-2 text-right">Fastest</th>
						<th class="px-3 py-2 text-right">Mejor pos.</th>
						<th class="px-3 py-2 text-right">Mejor tiempo</th>
					</tr>
				</thead>
				<tbody>
					{
						overallStandings.map((s, idx) => (
							<tr class={idx % 2 === 0 ? 'bg-[#030712]' : 'bg-[#050816]'}>
								<td class="px-3 py-2 text-[11px] text-slate-300">{idx + 1}</td>
								<td class="px-3 py-2 text-[11px]">
									<a
										href={`/pilotos/${s.driverId}`}
										class="font-medium text-slate-100 hover:text-fuchsia-300 transition-colors">
										{s.name}
									</a>
								</td>
								<td class="px-3 py-2 text-[11px] text-slate-300">
									{s.number ?? '-'}
								</td>
								<td class="px-3 py-2 text-[11px] text-slate-300">
									{s.team ?? '-'}
								</td>
								<td class="px-3 py-2 text-[11px]">
									{s.category ? (
										<span class="inline-flex items-center rounded-full border border-fuchsia-500/50 bg-fuchsia-500/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-[0.16em] text-fuchsia-200">
											{s.category}
										</span>
									) : (
										<span class="text-slate-500 text-[11px]">-</span>
									)}
								</td>
								<td class="px-3 py-2 text-[11px] text-right text-slate-300">
									{s.totalRaces}
								</td>
								<td class="px-3 py-2 text-[11px] text-right text-slate-300">
									{s.podiums}
								</td>
								<td class="px-3 py-2 text-[11px] text-right text-slate-300">
									{s.wins}
								</td>
								<td class="px-3 py-2 text-[11px] text-right text-fuchsia-300">
									{s.fastestLaps}
								</td>
								<td class="px-3 py-2 text-[11px] text-right text-slate-300">
									{s.bestPosition ?? '-'}
								</td>
								<td class="px-3 py-2 text-[11px] text-right font-semibold text-purple-300">
									{s.bestLapTime ?? '—'}
								</td>
							</tr>
						))
					}
				</tbody>
			</table>
		</div>
	</section>

	<!-- POR CATEGORÍA -->
	{
		categories.map(([catName, catStandings]) => (
			<section class="mb-8">
				<h2 class="mb-3 text-sm font-semibold uppercase tracking-[0.22em] text-slate-400">
					Clasificación · {catName}
				</h2>

				<div class="overflow-x-auto rounded-xl border border-slate-800 bg-[#050515]">
					<table class="min-w-full text-left text-xs">
						<thead class="border-b border-slate-800 bg-slate-900/60 text-[11px] uppercase tracking-[0.18em] text-slate-400">
							<tr>
								<th class="px-3 py-2">Pos</th>
								<th class="px-3 py-2">Piloto</th>
								<th class="px-3 py-2">#</th>
								<th class="px-3 py-2">Equipo</th>
								<th class="px-3 py-2 text-right">Carreras</th>
								<th class="px-3 py-2 text-right">Podios</th>
								<th class="px-3 py-2 text-right">Victorias</th>
								<th class="px-3 py-2 text-right">Fastest</th>
								<th class="px-3 py-2 text-right">Mejor pos.</th>
								<th class="px-3 py-2 text-right">Mejor tiempo</th>
							</tr>
						</thead>
						<tbody>
							{catStandings.map((s, idx) => (
								<tr class={idx % 2 === 0 ? 'bg-[#030712]' : 'bg-[#050816]'}>
									<td class="px-3 py-2 text-[11px] text-slate-300">
										{idx + 1}
									</td>
									<td class="px-3 py-2 text-[11px]">
										<a
											href={`/pilotos/${s.driverId}`}
											class="font-medium text-slate-100 hover:text-fuchsia-300 transition-colors">
											{s.name}
										</a>
									</td>
									<td class="px-3 py-2 text-[11px] text-slate-300">
										{s.number ?? '-'}
									</td>
									<td class="px-3 py-2 text-[11px] text-slate-300">
										{s.team ?? '-'}
									</td>
									<td class="px-3 py-2 text-[11px] text-right text-slate-300">
										{s.totalRaces}
									</td>
									<td class="px-3 py-2 text-[11px] text-right text-slate-300">
										{s.podiums}
									</td>
									<td class="px-3 py-2 text-[11px] text-right text-slate-300">
										{s.wins}
									</td>
									<td class="px-3 py-2 text-[11px] text-right text-fuchsia-300">
										{s.fastestLaps}
									</td>
									<td class="px-3 py-2 text-[11px] text-right text-slate-300">
										{s.bestPosition ?? '-'}
									</td>
									<td class="px-3 py-2 text-[11px] text-right font-semibold text-purple-300">
										{s.bestLapTime ?? '—'}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				</div>
			</section>
		))
	}
</MainLayout>
