---
import MainLayout from '../../layouts/MainLayout.astro';
import {
	DRIVER_CATEGORY_ORDER,
	drivers,
	getCategoryBadgeClass,
} from '../../lib/data';

// Orden para mostrar categorias (agregamos string vacio para pilotos sin categoria)
const categoryOrder = [...DRIVER_CATEGORY_ORDER, ''];
const hasUncategorized = drivers.some((d) => !d.category);
const filterCategories = [
	'Todos',
	...DRIVER_CATEGORY_ORDER,
	...(hasUncategorized ? ['Sin categoria'] : []),
];

const sortedDrivers = [...drivers].sort((a, b) => {
	const idxA = categoryOrder.indexOf(a.category ?? '');
	const idxB = categoryOrder.indexOf(b.category ?? '');
	if (idxA !== idxB) return idxA - idxB;

	if (a.number && b.number && a.number !== b.number) {
		return a.number - b.number;
	}

	return a.name.localeCompare(b.name);
});
---

<MainLayout
	title="Pilotos | Pericos"
	description="Conoce a todos los pilotos de la Pericos Karting League."
	image="/og-pilotos.jpg"
	path="/pilotos"
>
	<section class="mb-8">
		<p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
			Pericos Karting League
		</p>
		<h1 class="mt-1 text-2xl font-semibold tracking-tight sm:text-3xl">
			Pilotos
		</h1>
		<p class="mt-2 text-sm text-slate-300">
			La pole es buena, pero la amistad es mejor.
		</p>
	</section>

	<section class="space-y-5">
		<!-- FILTRO POR CATEGORIA -->
		<div class="flex flex-wrap gap-2 rounded-xl border border-slate-800 bg-[#050515] p-3 text-[11px] uppercase tracking-wide">
			<p class="text-slate-400 font-semibold">Filtrar:</p>
			<div class="flex flex-wrap gap-2">
				{filterCategories.map((cat, idx) => {
					const value =
						cat === 'Todos'
							? 'todos'
							: cat === 'Sin categoria'
								? 'none'
								: cat;

					return (
						<button
							class="filter-btn inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-slate-200 transition-colors hover:border-fuchsia-500/70 hover:text-fuchsia-200"
							data-filter={value}
							data-active={idx === 0 ? 'true' : 'false'}>
							{cat}
						</button>
					);
				})}
			</div>
		</div>

		<!-- GRID -->
		<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
			{sortedDrivers.map((driver) => {
				const badgeClass = getCategoryBadgeClass(driver.category);

				return (
					<a
						href={`/pilotos/${driver.id}`}
						class="driver-card group flex flex-col overflow-hidden rounded-2xl border border-slate-800 bg-[#050515] shadow-lg shadow-slate-950/40 transition-transform duration-200 hover:-translate-y-1 hover:border-fuchsia-500/60 hover:shadow-fuchsia-500/20"
						data-category={driver.category ?? 'none'}
					>
						<!-- FOTO -->
						<div class="relative h-40 w-full overflow-hidden bg-slate-900/80">
							{driver.photo ? (
								<img
									src={driver.photo}
									alt={driver.name}
									class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
									loading="lazy"
								/>
							) : (
								<div class="flex h-full w-full items-center justify-center text-xs text-slate-500">
									Sin foto
								</div>
							)}

							<!-- Badge de categoria -->
							{driver.category && (
								<span
									class={`absolute left-2 top-2 inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide ${badgeClass}`}
								>
									{driver.category}
								</span>
							)}
						</div>

						<!-- CONTENIDO -->
						<div class="flex flex-1 flex-col px-3 py-3">
							<div class="mb-1 flex items-baseline justify-between gap-2">
								<div class="flex items-baseline gap-2">
									{driver.number && (
										<span class="font-mono text-lg font-bold text-fuchsia-400 drop-shadow-[0_0_10px_rgba(244,114,182,0.6)]">
											{driver.number}
										</span>
									)}
									<h2 class="text-sm font-semibold text-slate-50">
										{driver.name}
									</h2>
								</div>
							</div>

							{driver.team && (
								<p class="text-[11px] font-medium uppercase tracking-wide text-slate-400">
									{driver.team}
								</p>
							)}

							{driver.city && (
								<p class="mt-1 text-[11px] text-slate-400">
									{driver.city}
								</p>
							)}

							{driver.bio && (
								<p class="mt-2 line-clamp-2 text-xs text-slate-300">
									{driver.bio}
								</p>
							)}

							<div class="mt-3 flex items-center justify-between text-[11px] text-slate-400">
								<span class="inline-flex items-center gap-1">
									<span class="h-1 w-4 rounded-full bg-gradient-to-r from-fuchsia-500 via-purple-400 to-sky-400" />
									<span>Piloto</span>
								</span>
								<span class="text-[10px] uppercase tracking-wide text-fuchsia-300 group-hover:text-fuchsia-200">
									Ver perfil Â»
								</span>
							</div>
						</div>
					</a>
				);
			})}
		</div>
	</section>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const buttons = Array.from(
				document.querySelectorAll('[data-filter]')
			);
			const cards = Array.from(
				document.querySelectorAll('[data-category]')
			);

			const setActive = (value) => {
				buttons.forEach((btn) => {
					const isActive = btn.dataset.filter === value;
					btn.dataset.active = isActive ? 'true' : 'false';

					btn.classList.toggle('bg-fuchsia-600', isActive);
					btn.classList.toggle('border-fuchsia-500', isActive);
					btn.classList.toggle('text-white', isActive);

					btn.classList.toggle('bg-slate-900/60', !isActive);
					btn.classList.toggle('border-slate-800', !isActive);
					btn.classList.toggle('text-slate-200', !isActive);
				});
			};

			const applyFilter = (value) => {
				setActive(value);
				cards.forEach((card) => {
					const cat = card.dataset.category || 'none';
					const shouldShow =
						value === 'todos' ||
						(value === 'none' && cat === 'none') ||
						cat === value;

					card.classList.toggle('hidden', !shouldShow);
				});
			};

			buttons.forEach((btn) => {
				btn.addEventListener('click', () => {
					applyFilter(btn.dataset.filter || 'todos');
				});
			});

			// Estado inicial
			const initial =
				document.querySelector('[data-filter][data-active="true"]')
					?.dataset.filter || 'todos';
			applyFilter(initial);
		});
	</script>
</MainLayout>
