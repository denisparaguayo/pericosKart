---
import MainLayout from '../../layouts/MainLayout.astro';
import {
	drivers,
	getCategoryBadgeClass,
	getDriverById,
	races,
} from '../../lib/data';

export function getStaticPaths() {
	return drivers.map((driver) => ({
		params: { slug: driver.id },
	}));
}

const { slug } = Astro.params;
const driver = slug ? getDriverById(slug) : undefined;

if (!driver) {
	throw new Error('Piloto no encontrado');
}

const badgeClass = getCategoryBadgeClass(driver.category);

// Carreras donde aparece este piloto
const driverRaces = races.filter((race) => {
	const onPodium = race.podium.some((p) => p.driverId === driver.id);
	const isFastest = race.fastestLap?.driverId === driver.id;
	return onPodium || isFastest;
});

// Entradas de podio
const podiumEntries = driverRaces
	.map((race) => {
		const p = race.podium.find((p) => p.driverId === driver.id);
		return p ? { race, position: p.position } : null;
	})
	.filter(Boolean);

// Stats
const totalRaces = driverRaces.length;
const totalPodiums = podiumEntries.length;
const totalWins = podiumEntries.filter((e) => e.position === 1).length;
const totalFastestLaps = driverRaces.filter(
	(race) => race.fastestLap?.driverId === driver.id
).length;
const bestPosition = podiumEntries.length
	? Math.min(...podiumEntries.map((e) => e.position))
	: null;

// Timeline ordenado
const timeline = [...driverRaces].sort(
	(a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()
);

function getPositionForRace(race, driverId) {
	const podiumPos = race.podium.find((p) => p.driverId === driverId);
	return podiumPos ? podiumPos.position : null;
}

function getBarHeight(position) {
	if (!position) return 32;
	if (position === 1) return 96;
	if (position === 2) return 80;
	if (position === 3) return 64;
	return 48;
}
---

<MainLayout
	title={`Piloto ¶ú ${driver.name}`}
	description={driver.bio ?? 'Piloto de karting amateur.'}
	image={driver.photo ?? '/og-pilotos.jpg'}
	path={`/pilotos/${driver.id}`}>
	<!-- HEADER -->
	<section class="mb-8 grid gap-6 md:grid-cols-[2fr,1.6fr]">
		<div class="flex gap-4">
			{
				driver.photo && (
					<button
						id="driver-photo"
						data-src={driver.photo}
						class="h-24 w-24 md:h-32 md:w-32 overflow-hidden rounded-xl border border-slate-800 bg-slate-900/70 shadow-lg transition-transform hover:-translate-y-1">
						<img
							src={driver.photo}
							alt={driver.name}
							class="h-full w-full object-cover"
						/>
					</button>
				)
			}

			<div class="flex-1">
				<p class="text-[11px] uppercase tracking-[0.22em] text-slate-400">
					Piloto
				</p>

				<div class="mt-1 flex items-baseline gap-2">
					{
						driver.number && (
							<span class="font-mono text-3xl font-bold text-fuchsia-400 drop-shadow">
								{driver.number}
							</span>
						)
					}
					<h1 class="text-2xl font-semibold sm:text-3xl">{driver.name}</h1>
				</div>

				{
					driver.team && (
						<p class="mt-1 text-[11px] uppercase tracking-wide text-slate-300">
							{driver.team}
						</p>
					)
				}

				<!-- BADGE DE CATEGORÇ?A CON COLOR -->
				{
					driver.category && (
						<span
							class={`mt-2 inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[10px] font-semibold uppercase tracking-wider ${badgeClass}`}>
							<span class="h-1.5 w-1.5 rounded-full bg-black/40" />
							{driver.category}
						</span>
					)
				}

				{
					driver.city && (
						<p class="mt-1 text-xs text-slate-400">{driver.city}</p>
					)
				}
				{driver.bio && <p class="mt-3 text-sm text-slate-300">{driver.bio}</p>}

				<a
					href={`/pilotos/${driver.id}/poster`}
					class="mt-3 inline-flex text-[11px] px-3 py-1 border rounded-full border-slate-700 hover:border-fuchsia-500 hover:text-fuchsia-300">
					Ver poster / compartir
				</a>
			</div>
		</div>

		<!-- FICHA RÇ?PIDA -->
		<div class="rounded-xl border border-slate-800 bg-[#0b0b19] p-4 text-xs">
			<p class="text-[11px] uppercase tracking-widest text-slate-400">
				Ficha rÇ­pida
			</p>

			<div class="grid grid-cols-2 gap-3 mt-2">
				{
					driver.number && (
						<div>
							<p class="text-[11px] text-slate-400">NÇ§mero</p>
							<p class="text-sm font-semibold">#{driver.number}</p>
						</div>
					)
				}

				{
					driver.helmetColor && (
						<div>
							<p class="text-[11px] text-slate-400">Colores</p>
							<p class="text-sm">{driver.helmetColor}</p>
						</div>
					)
				}

				{
					driver.category && (
						<div>
							<p class="text-[11px] text-slate-400">CategorÇða</p>
							<p class="text-sm">{driver.category}</p>
						</div>
					)
				}

				<div>
					<p class="text-[11px] text-slate-400">Carreras</p>
					<p class="text-sm">{totalRaces}</p>
				</div>
			</div>

			<div class="grid grid-cols-4 gap-2 mt-4 text-center">
				<div class="rounded bg-slate-900/70 p-2">
					<p class="text-[10px] text-slate-400">Podios</p>
					<p class="text-sm">{totalPodiums}</p>
				</div>
				<div class="rounded bg-slate-900/70 p-2">
					<p class="text-[10px] text-slate-400">Victorias</p>
					<p class="text-sm text-amber-300">{totalWins}</p>
				</div>
				<div class="rounded bg-slate-900/70 p-2">
					<p class="text-[10px] text-slate-400">Fastest</p>
					<p class="text-sm text-fuchsia-300">{totalFastestLaps}</p>
				</div>
				<div class="rounded bg-slate-900/70 p-2">
					<p class="text-[10px] text-slate-400">Mejor pos.</p>
					<p class="text-sm text-emerald-300">
						{bestPosition ? `${bestPosition}¶ø` : '-'}
					</p>
				</div>
			</div>
		</div>
	</section>

	<!-- GRÇ?FICO DE RENDIMIENTO -->
	<section class="mb-8 rounded-xl border border-slate-800 bg-[#050515] p-4">
		<p class="text-[11px] uppercase tracking-widest text-slate-400">
			Rendimiento por carrera
		</p>

		{
			timeline.length === 0 ? (
				<p class="text-sm text-slate-400 mt-2">No hay carreras registradas.</p>
			) : (
				<div class="mt-4 flex items-end gap-3 overflow-x-auto pb-2">
					{timeline.map((race) => {
						const position = getPositionForRace(race, driver.id);
						const height = getBarHeight(position);
						const isFast = race.fastestLap?.driverId === driver.id;

						return (
							<div class="flex flex-col items-center min-w-[60px]">
								<div
									class={`w-6 flex items-end justify-center rounded-t-full ${
										position === 1
											? 'bg-amber-400'
											: position === 2
												? 'bg-slate-300'
												: position === 3
													? 'bg-amber-700'
													: 'bg-slate-700'
									} ${isFast ? 'ring-2 ring-fuchsia-500' : ''}`}
									style={{ height: `${height}px` }}>
									{position && <span class="text-[10px] mb-1">{position}</span>}
								</div>

								<p class="text-[10px] text-slate-400">R{race.round}</p>
								{isFast && <p class="text-[9px] text-fuchsia-300">FL</p>}
							</div>
						);
					})}
				</div>
			)
		}
	</section>

	<!-- RESULTADOS DETALLADOS -->
	<section>
		<h2 class="text-lg font-semibold mb-2">Resultados del piloto</h2>

		{
			driverRaces.length === 0 ? (
				<p class="text-sm text-slate-400">No hay resultados cargados.</p>
			) : (
				<div class="space-y-3">
					{driverRaces.map((race) => {
						const podiumPos = race.podium.find((p) => p.driverId === driver.id);
						const isFastest = race.fastestLap?.driverId === driver.id;

						return (
							<article class="p-3 rounded-lg border border-slate-800 bg-[#0b0b19] hover:border-fuchsia-500/40">
								<div class="flex justify-between">
									<div>
										<p class="text-[11px] text-slate-400 uppercase">
											Ronda {race.round}
										</p>
										<p class="text-sm text-slate-100">{race.track}</p>
									</div>

									<div class="text-xs text-slate-400">
										<p>
											{new Date(race.date).toLocaleDateString('es-PY', {
												day: '2-digit',
												month: 'short',
												year: 'numeric',
											})}
										</p>
										{race.layout && <p>Layout: {race.layout}</p>}
									</div>
								</div>

								<div class="mt-2 flex flex-wrap gap-3">
									{podiumPos && (
										<span class="bg-slate-900 px-3 py-1 text-[11px] rounded-full">
											PosiciÇün: <strong>{podiumPos.position}¶ø</strong>
										</span>
									)}

									{isFastest && (
										<span class="bg-purple-900/60 px-3 py-1 text-[11px] rounded-full text-purple-200">
											Fastest Lap ¶ú {race.fastestLap.time}
										</span>
									)}
								</div>
							</article>
						);
					})}
				</div>
			)
		}
	</section>

	<!-- LIGHTBOX -->
	<div
		id="lightbox-driver"
		class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 p-4">
		<img
			id="lightbox-driver-img"
			class="max-h-[90vh] max-w-[90vw] rounded-xl shadow-xl"
		/>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const btn = document.getElementById('driver-photo');
			const lb = document.getElementById('lightbox-driver');
			const img = document.getElementById('lightbox-driver-img');
			if (!btn || !lb || !img) return;

			btn.addEventListener('click', () => {
				img.src = btn.dataset.src;
				lb.classList.remove('hidden');
				lb.classList.add('flex');
				document.body.classList.add('overflow-hidden');
			});

			lb.addEventListener('click', () => {
				lb.classList.add('hidden');
				document.body.classList.remove('overflow-hidden');
			});
		});
	</script>
</MainLayout>
